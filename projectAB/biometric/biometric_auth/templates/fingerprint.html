{% load static %}
<!DOCTYPE html>
<!-- filepath: /c:/Users/VICTUS/projectAB/biometric/biometric_auth/templates/fingerprint.html -->

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fingerprint Registration</title>
    <link
      rel="icon"
      type="image/png"
      href="{% static 'images/logo-no-background.png' %}"
    />
    <link rel="stylesheet" href="{% static 'css/fingerprint.css' %}" />
    <style>
      .button-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      #next-btn {
        margin: 0 auto;
      }
      .file-input-container {
        display: none;
        margin-top: 20px;
        text-align: center;
      }
      .file-input-container input[type="file"] {
        display: none;
      }
      .file-input-container label {
        display: inline-block;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
      .file-input-container label:hover {
        background-color: #0056b3;
      }
      .error-message {
        color: red;
        margin-top: 10px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Fingerprint Registration</h1>
      <div class="fingerprint">
        <!-- Include the provided SVG -->
        <svg
          version="1.1"
          id="Capa_1"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:xlink="http://www.w3.org/1999/xlink"
          x="0px"
          y="0px"
          viewBox="0 0 58.999 58.999"
          style="enable-background: new 0 0 58.999 58.999"
          xml:space="preserve"
        >
          <!-- Fingerprint paths -->
          <path
            id="section1"
            class="fingerprint-section"
            style="fill: #c7cac7"
            d="M29.083,26.038c-0.53,0.154-0.836,0.708-0.683,1.239c0.027,0.093,2.697,9.591,1.962,30.687
            c-0.02,0.553,0.412,1.016,0.964,1.034c0.012,0.001,0.024,0.001,0.036,0.001c0.536,0,0.979-0.425,0.998-0.965
            c0.747-21.414-1.925-30.919-2.038-31.313C30.169,26.19,29.616,25.888,29.083,26.038z"
          />
          <path
            id="section2"
            class="fingerprint-section"
            style="fill: #c7cac7"
            d="M54.228,16.479C49.992,6.469,40.232,0,29.362,0c-3.587,0-7.085,0.701-10.396,2.083
            c-1.834,0.765-3.567,1.675-5.151,2.704c-0.463,0.302-0.595,0.921-0.294,1.384c0.302,0.463,0.922,0.595,1.384,0.294
            c1.483-0.964,3.108-1.817,4.831-2.536C22.803,2.648,26.041,2,29.362,2c10.064,0,19.102,5.989,23.023,15.259
            c1.63,3.854,2.511,10.95,2.891,14.838c0.051,0.517,0.485,0.902,0.994,0.902c0.032,0,0.065-0.002,0.099-0.005
            c0.549-0.054,0.951-0.543,0.897-1.093C56.789,27.015,55.875,20.372,54.228,16.479z"
          />
          <path
            id="section3"
            class="fingerprint-section"
            style="fill: #c7cac7"
            d="M10.851,9.711c0.394-0.387,0.397-1.021,0.01-1.414c-0.387-0.393-1.02-0.397-1.414-0.01
            C4.069,13.585-1.288,23.438,3.73,40.284c0.129,0.435,0.526,0.715,0.958,0.715c0.094,0,0.19-0.014,0.285-0.042
            c0.529-0.157,0.831-0.714,0.673-1.243C1.899,27.132,3.698,16.758,10.851,9.711z"
          />
          <path
            id="section4"
            class="fingerprint-section"
            style="fill: #c7cac7"
            d="M30.13,6.014c-3.06-0.119-6.038,0.432-8.853,1.606C11.471,11.711,6.257,22.494,9.15,32.704
            c0.289,1.021,0.585,2.107,0.744,3.189c0.358,2.449,0.377,6.956,0.377,14.105c0,0.553,0.447,1,1,1s1-0.447,1-1
            c0-7.458-0.019-11.804-0.398-14.396c-0.176-1.202-0.491-2.36-0.799-3.444c-2.617-9.236,2.1-18.992,10.973-22.693
            c2.548-1.063,5.259-1.546,8.012-1.454C37.17,8.267,45.23,14.535,47.661,21.7c2.104,6.199,2.122,16.76,1.861,26.271
            c-0.015,0.552,0.421,1.012,0.973,1.027c0.542-0.01,1.012-0.419,1.027-0.973c0.265-9.689,0.238-20.471-1.967-26.969
            C46.838,13.049,38.124,6.3,30.13,6.014z"
          />
          <path
            id="section5"
            class="fingerprint-section"
            style="fill: #c7cac7"
            d="M21.935,16.337c0.452-0.317,0.562-0.941,0.244-1.393c-0.316-0.452-0.941-0.563-1.393-0.244
            c-5.15,3.616-7.388,10.563-5.565,17.295c0.021,0.073,2.051,7.462,2.051,19.004c0,0.553,0.447,1,1,1s1-0.447,1-1
            c0-11.813-2.038-19.232-2.123-19.535C15.548,25.55,17.472,19.471,21.935,16.337z"
          />
          <path
            id="section6"
            class="fingerprint-section"
            style="fill: #c7cac7"
            d="M29.362,12c-1.087,0-2.169,0.117-3.218,0.349c-0.539,0.119-0.88,0.652-0.761,1.192
            c0.119,0.539,0.646,0.873,1.192,0.761c0.907-0.2,1.845-0.302,2.786-0.302c5.233,0,9.933,3.114,11.972,7.935
            c2.43,5.74,2.589,14.953,2.028,31.029c-0.02,0.552,0.412,1.016,0.964,1.034c0.012,0.001,0.024,0.001,0.036,0.001
            c0.536,0,0.979-0.425,0.998-0.965c0.584-16.723,0.406-25.758-2.185-31.879C40.823,15.594,35.401,12,29.362,12z"
          />
          <path
            id="section7"
            class="fingerprint-section"
            style="fill: #c7cac7"
            d="M39.272,48.006c0.004-0.553-0.44-1.003-0.993-1.007c-0.002,0-0.005,0-0.007,0
            c-0.549,0-0.996,0.443-1,0.993c-0.005,0.752,0.02,1.85,0.047,3.036c0.039,1.725,0.083,3.68,0.04,4.937
            c-0.02,0.552,0.412,1.015,0.965,1.033c0.012,0.001,0.023,0.001,0.035,0.001c0.536,0,0.979-0.425,0.998-0.966
            c0.046-1.313,0.001-3.299-0.039-5.051C39.291,49.82,39.267,48.743,39.272,48.006z"
          />
          <path
            id="section8"
            class="fingerprint-section"
            style="fill: #c7cac7"
            d="M29.362,19c-1.062,0-2.098,0.208-3.081,0.618c-3.892,1.624-5.783,6.015-4.4,10.214
            c0.754,2.289,1.391,14.272,1.391,26.167c0,0.553,0.447,1,1,1s1-0.447,1-1c0-10.707-0.57-23.995-1.49-26.792
            c-1.054-3.197,0.353-6.526,3.27-7.743C27.789,21.156,28.566,21,29.362,21c2.415,0,4.584,1.438,5.529,3.67
            c1.867,4.419,2.422,12.419,2.558,18.353c0.013,0.544,0.458,0.977,1,0.977c0.007,0,0.016,0,0.023,0
            c0.552-0.013,0.989-0.471,0.977-1.023c-0.141-6.106-0.726-14.375-2.72-19.093C35.475,20.917,32.583,19,29.362,19z"
          />
        </svg>
        <div class="progress-text">0%</div>
      </div>
      <div class="finger-label">Upload Fingerprint Image</div>
      <div class="button-container">
        <div class="file-input-container">
          <input type="file" id="fingerprint-file" accept=".bmp" />
          <label for="fingerprint-file">Upload Fingerprint Image</label>
          <div class="error-message" id="error-message"></div>
        </div>
        <button id="next-btn" style="display: none">Next Finger</button>
      </div>
    </div>

    <script>
      let auth_success = 0;
      const sections = document.querySelectorAll(".fingerprint-section");
      const progressText = document.querySelector(".progress-text");
      const fileInput = document.getElementById("fingerprint-file");
      const nextBtn = document.getElementById("next-btn");
      const fingerLabel = document.querySelector(".finger-label");
      const errorMessage = document.getElementById("error-message");
      const fileInputContainer = document.querySelector(
        ".file-input-container"
      );

      let progress = 0;

      const totalSections = sections.length;
      let currentFinger = 1;
      const totalFingers = 4;

      // Store the dashboard URL
      const dashUrl = "{% url 'dash' %}";

      // Show file input container initially
      fileInputContainer.style.display = "block";

      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          // Check if file is BMP
          if (
            file.type === "image/bmp" ||
            file.name.toLowerCase().endsWith(".bmp")
          ) {
            errorMessage.style.display = "none";

            // Create FormData and append file
            const formData = new FormData();
            formData.append("fingerprint", file);
            formData.append("finger_number", currentFinger);

            // Send file to server
            fetch("{% url 'upload_fingerprint' %}", {
              method: "POST",
              headers: {
                "X-CSRFToken": getCookie("csrftoken"),
              },
              credentials: "same-origin",
              body: formData,
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then((data) => {
                if (data.success) {
                  fileInputContainer.style.display = "none";
                  simulateRegistration();
                  auth_success = data.auth_success;
                  register = data.register;
                  Id = data.rfid;
                } else {
                  errorMessage.textContent =
                    data.error || "Error processing file";
                  errorMessage.style.display = "block";
                  fileInput.value = ""; // Clear the file input
                }
              })

              .catch((error) => {
                console.error("Error:", error);
                errorMessage.textContent =
                  "Error processing file. Please try again. Error: " +
                  error.message;
                errorMessage.style.display = "block";
                fileInput.value = ""; // Clear the file input
              });
          } else {
            errorMessage.textContent = "Please upload a BMP file";
            errorMessage.style.display = "block";
            fileInput.value = ""; // Clear the file input
          }
        }
      });

      nextBtn.addEventListener("click", () => {
        if (currentFinger < totalFingers) {
          currentFinger++;
          fingerLabel.textContent = `Upload Finger ${currentFinger}`;
          progress = 0;
          progressText.textContent = `${progress}%`;
          sections.forEach((section) => (section.style.fill = "#C7CAC7"));
          nextBtn.style.display = "none";
          fileInputContainer.style.display = "block";
          fileInput.value = ""; // Clear the file input
        } else {
          // All fingers processed, redirect to dashboard
          fingerLabel.textContent = "All Fingers Processed Successfully!";
          nextBtn.style.display = "none";

          // Redirect to dashboard after a short delay
        }
      });

      function simulateRegistration() {
        let currentSection = 0;
        const interval = setInterval(() => {
          if (currentSection < totalSections) {
            sections[currentSection].style.fill = "#007bff";
            currentSection++;
            progress = Math.round((currentSection / totalSections) * 100);
            progressText.textContent = `${progress}%`;
          } else {
            clearInterval(interval);
            progressText.textContent = "100%";

            if (currentFinger < totalFingers) {
              fingerLabel.textContent = `Finger ${currentFinger} Processed Successfully!`;
              nextBtn.style.display = "block";
            } else {
              fingerLabel.textContent = "All Fingers Processed Successfully!";
              nextBtn.textContent = "Continue";
              if (register == 1) {
                alert("registration succesfull");
                window.location.href = "{% url 'owner' %}";
              } else {
                if (auth_success >= 3) {
                  alert("authentications succesfull");
                  if (Id) {
                    alert("user have cheked in succesfully");
                    window.location.href = "{% url 'checked' %}";
                    z;
                  } else {
                    window.location.href = dashUrl;
                  }
                } else {
                  alert("authentication failed");

                  window.location.href = "{% url 'home' %}";
                }
              }
            }
          }
        }, 1050);
      }

      // Function to get CSRF token from cookies
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
  </body>
</html>
